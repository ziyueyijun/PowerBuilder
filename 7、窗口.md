# 窗口

## 1、参数

### 1.1、字符串

```c
// 1、传递
openwithparm( 新窗口名称 , '1' )
//closewithreturn( 当前窗口名称 , '1' )

// 2、接收
string  ls_str 
ls_str = message.stringparm
messagebox('提示',ls_str);
```

### 1.2、数值

```c
// 1、传递
openwithparm( 新窗口名称 , 1 )
//closewithreturn( 当前窗口名称 , 1 )

// 2、接收
double  ldb_double
ldb_double = message.doubleparm
messagebox('提示',ldb_double);
```

### 1.3、结构体

```c
// 1、传递
st_parameter s_pm
s_pm.a = 1
openwithparm( 新窗口名称 , s_pm )
//closewithreturn( 当前窗口名称 , s_pm ) 

// 2、新窗口 ——> 接收
st_parameter s_pm 
s_pm =  message.powerobjectparm
messagebox('提示',s_pm.a)
```

### 1.4、用户对象

```c
// 1、传递
u_parameter  u_pm
u_pm = create u_parameter
u_pm.a = '1'
openwithparm( 新窗口名称 , u_pm )

// 2、接收
u_parameter u_pm 
u_pm =  message.powerobjectparm
messagebox('提示',u_pm.a)
```

### 1.5、用户对象（ 可视化 ）

```c
u_customvisual u_cv
u_cv = create  u_customvisual
openuserobjectwithparm(u_cv,1)
```

## 2、游标

### 2.1、用  for  循环实现游标

```c
long ll_count = 10

//定义游标
string test

//声明游标
declare test cursor for 

// SQL 语句
select 字段名 from  表名 where 表达式 using sqlca; 

//打开游标
open test; 

for i=1 to ll_count
 //获取数据
 fetch test into :变量名; 
 
 //在这里写你的业务
 
next

//关闭游标
close test;
```

### 2.2、用 do while  循环实现游标

```c
//定义游标
string test 

//声明游标
declare test cursor for 
  
// SQL语句
select 字段名 from 表名 where 条件 using sqlca;

//打开游标
open test;

//获取数据
fetch test into:字段名变量;

do while sqlca.sqlcode = 0

 //在这里写你的业务
 
 //再次获取数据
 fetch test into:字段名变量; 
 
loop

//关闭游标
close test;
```

## 3、SQL

### 3.1、立即执行

```c
string ls_sql,ls_err
ls_sql = "update 表名 set 字段名 =:字段值 where 表达式条件"
//执行SQL语句
execute immediate :ls_sql using sqlca;
if sqlca.sqlcode = 0 then
    commit using sqlca;
    messagebox('提示','执行成功')
else
    ls_err = sqlca.sqlerrtext
    rollback using sqlca;
    messagebox('提示','执行失败' + ls_err)
end if
```

### 3.2、预处理

```c
long ll_id
string ls_name
ls_sql = "select 字段名 from 表名 where id=? "
ll_id= 10
//定义动态SQL
declare test dynamic cursor for sqlsa;
//准备要执行的SQL
prepare sqlsa from :ls_sql;
//打开动态SQL语句，并将 ll_id 作为参数执行
open dynamic test using :ll_id;
//获取SQL语句的执行结果
fetch test into :ls_name;
//关闭动态SQL
close test;
```

### 3.3、动态执行

```c
string ls_sql
ls_sql = "select count(*) from 表名 where id = 10 "
//定义动态SQL
declare test dynamic cursor for sqlsa;
//准备要执行的SQL
prepare sqlsa from :ls_sql;
//打开动态SQL语句
open dynamic test;
//执行动态SQL语句，并获取返回值
fetch test into :ll_state;
//关闭动态SQL
close test;
```

## ‍4、浏览器

### 4.1、打开一个网页

```c
Inet iinet_base
GetContextService("Internet", iinet_base)
iinet_base.HyperlinkToURL('www.baidu.com')
```

### 4.2、通过默认浏览器打开一个网页

```c
//声明函数
function long shRunDefltBrowser(string szUrl) library "pbvm90.dll"
//调用函数
shRunDefltBrowser("www.baidu.com")
```

## 5、存储过程

### 5.1、创建存储过程

> 在 SqlServer 数据库中先创建存储过程

```sql
create procedure sp_test
 @param varchar(30)='',
 @refcode int output,
 @refmsg varchar(50) output
as

/*
存储过程：sp_test
功能：PowerBuilder 调用测试
入参：
	@param 传入的参数
出参：
	@refcode 返回状态码
	@refmsg 返回的提示信息
*/

-- 返回的状态码
set @refcode = 200
--返回的提示信息
set @refmsg = '请求成功'
--返回的结果集
select id,name from (
	select 1 as id,'张三' name
	union
	select 2 as id,'李四' name
) tab
```

### 5.2、调用存储过程

> 在 PowerBuilder 中调用存储过程

```c
string test,ls_param,ls_refmsg
long row = 0,li_refcode

ls_param = '我是存储过程入参';

//1、声明存储过程实例
declare test  procedure for sp_test
	@param = :ls_param,
	@refcode = :li_refcode output,
	@refmsg = :ls_refmsg  output
	using sqlca;

//2、执行存储过程实例
execute test;

if sqlca.sqlcode = 0 then
	
	//3、接收结果集
	string ls_id,ls_name
	do
		fetch test  into:ls_id,:ls_name;
		if  sqlca.sqlcode = 0 then
			row ++
		elseif sqlca.sqlcode = 100 then
			messagebox ("提示","接收结果集完成，共" + string(row) + ' 条数据!')
			goto parm
		else
			rollback using sqlca;
			messagebox ("提示","接收结果集失败~r~n" + string (sqlca.sqldbcode) + " = " + sqlca.sqlerrtext)
             return -1
		end if
	loop while sqlca.sqlcode = 0
	
	parm:
	
	//4、接收返回参数
	fetch test  into:li_refcode,:ls_refmsg;
	if  sqlca.sqlcode = 0 then
		messagebox ("提示","返回的状态码为：" + string(li_refcode) + ",返回的提示信息为：" + ls_refmsg )
	elseif sqlca.sqlcode = 100 then
		messagebox ("提示", "调用存储过程没有返回接收参数")
        return -1
	else
		rollback using sqlca;
		messagebox ("提示","接收返回参数失败~r~n" + string (sqlca.sqldbcode) + " = " + sqlca.sqlerrtext)
         return -1
	end if
	
	close test;
	
elseif sqlca.sqlcode = 100 then
	messagebox ("提示", "调用存储过程没有返回结果集")
    return -1
else
	rollback using sqlca;
	messagebox ("调用存储过程失败",string (sqlca.sqldbcode) + " = " + sqlca.sqlerrtext)
    return -1
end if
    
return 0
```

